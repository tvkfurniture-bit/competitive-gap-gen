# GitHub Actions Workflow for Competitive Revenue Gap Generator (CRGG)
# Location: .github/workflows/crgg_pipeline.yml

name: CRGG Production Pipeline

on:
  # Allows manual running from the 'Actions' tab (crucial for testing)
  workflow_dispatch:
  
  # Sets the production schedule: Runs every day at 08:00 UTC (modify as needed)
  schedule:
    - cron: '0 8 * * *'  
  
  # Runs on every code change pushed to the main branch
  push:
    branches: [ main ]

jobs:
  # ===============================================
  # JOB 1: QUALITY & DEPENDENCY CHECK (CI)
  # Ensures the code is clean and dependencies are correct before running production.
  # ===============================================
  quality_check:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4
      
      - name: Set up Python 3.11
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip' # Use pip caching to speed up subsequent runs

      - name: Install Python Dependencies
        run: pip install -r requirements.txt
      
      - name: Install Spacy NLP Model
        # CRITICAL: Spacy requires an explicit download command
        run: python -m spacy download en_core_web_sm

      - name: Run Code Linter (Flake8)
        # Ensures adherence to PEP8 standards (essential for maintainable code)
        run: |
          pip install flake8
          # Exclude the hidden .github folder from linting
          flake8 . --exclude .github,venv

  # ===============================================
  # JOB 2: DAILY REPORT GENERATION (CD/Production)
  # Runs the CRGG core script and securely handles API keys.
  # ===============================================
  daily_report_generator:
    runs-on: ubuntu-latest
    needs: quality_check  # ONLY run if the quality check job was successful
    
    # Ensures this job only runs when explicitly requested or on the daily schedule
    if: success() && (github.event_name == 'schedule' || github.event_name == 'workflow_dispatch')

    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Set up Python Environment
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install Dependencies & Spacy
        run: |
          pip install -r requirements.txt
          python -m spacy download en_core_web_sm
          
      - name: Configure API Keys Securely (.env creation)
        # Writes the secret key (stored in GitHub Settings) into a temporary .env file
        # Python's `python-dotenv` (in requirements.txt) will read this securely.
        run: |
          echo "GOOGLE_MAPS_API_KEY=${{ secrets.GOOGLE_MAPS_API_KEY }}" > .env
        
      - name: Run CRGG Report Generation
        # This executes the main logic (main.py) which prints the output report.
        run: python main.py > crgg_report_output.log

      - name: Upload Daily Report Log (Artifact)
        # Makes the log/output file accessible on the GitHub Actions run page
        uses: actions/upload-artifact@v4
        with:
          name: CRGG-Daily-Production-Log
          path: crgg_report_output.log
